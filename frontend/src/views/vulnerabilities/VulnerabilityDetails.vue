<template>
  <div class="vulnerability-details-page">
    <div class="page-header">
      <div class="header-back">
        <el-button @click="goBack" icon="el-icon-arrow-left" type="text">
          返回列表
        </el-button>
      </div>
      <div class="header-actions">
        <el-button @click="handleEdit" type="primary" plain :disabled="!canEdit">
          编辑
        </el-button>
        <el-dropdown @command="handleCommand" trigger="click">
          <el-button>
            操作
            <i class="el-icon-arrow-down el-icon--right"></i>
          </el-button>
          <template #dropdown>
            <el-dropdown-menu>
              <el-dropdown-item command="open" :disabled="vulnerability.status === 'open'">
                标记为开放
              </el-dropdown-item>
              <el-dropdown-item command="in_progress" :disabled="vulnerability.status === 'in_progress'">
                标记为处理中
              </el-dropdown-item>
              <el-dropdown-item command="resolved" :disabled="vulnerability.status === 'resolved'">
                标记为已解决
              </el-dropdown-item>
              <el-dropdown-item command="false_positive" :disabled="vulnerability.status === 'false_positive'">
                标记为误报
              </el-dropdown-item>
              <el-dropdown-item command="closed" :disabled="vulnerability.status === 'closed'">
                标记为已关闭
              </el-dropdown-item>
              <el-dropdown-item divided command="delete" type="danger">
                <span style="color: #F56C6C;">删除漏洞</span>
              </el-dropdown-item>
            </el-dropdown-menu>
          </template>
        </el-dropdown>
      </div>
    </div>

    <div v-loading="loading">
      <!-- 漏洞不存在的错误信息 -->
      <el-empty 
        v-if="!loading && !vulnerability.id" 
        description="未找到漏洞信息" 
      >
        <el-button type="primary" @click="goBack">返回列表</el-button>
      </el-empty>

      <!-- 漏洞详情内容 -->
      <template v-if="vulnerability.id">
        <div class="vuln-header">
          <div class="vuln-title-section">
            <h1 class="vuln-title">{{ vulnerability.title }}</h1>
            <div class="vuln-meta">
              <el-tag 
                class="vuln-severity" 
                :type="$filters.severityClass(vulnerability.severity)"
              >
                {{ $filters.severityText(vulnerability.severity) }}
              </el-tag>
              <el-tag 
                class="vuln-status" 
                :type="$filters.statusClass(vulnerability.status)"
              >
                {{ $filters.statusText(vulnerability.status) }}
              </el-tag>
              <span class="vuln-id">ID: {{ vulnerability.id }}</span>
              <span v-if="vulnerability.cve" class="vuln-cve">
                CVE: {{ vulnerability.cve }}
              </span>
            </div>
          </div>
          
          <div class="vuln-dates">
            <div class="date-item">
              <div class="date-label">发现时间</div>
              <div class="date-value">{{ $filters.formatDate(vulnerability.discoveredAt) }}</div>
            </div>
            <div class="date-item">
              <div class="date-label">上次更新</div>
              <div class="date-value">{{ $filters.formatDate(vulnerability.updatedAt) }}</div>
            </div>
          </div>
        </div>

        <!-- 漏洞详情卡片布局 -->
        <div class="details-grid">
          <!-- 主要信息卡片 -->
          <el-card class="details-card main-info-card">
            <template #header>
              <div class="card-header">
                <h3>漏洞详情</h3>
              </div>
            </template>
            
            <div class="card-section">
              <h4 class="section-title">描述</h4>
              <div class="section-content markdown-body" v-html="renderedDescription"></div>
            </div>

            <div class="card-section" v-if="vulnerability.impact">
              <h4 class="section-title">影响</h4>
              <div class="section-content markdown-body" v-html="renderedImpact"></div>
            </div>

            <div class="card-section" v-if="vulnerability.steps_to_reproduce">
              <h4 class="section-title">复现步骤</h4>
              <div class="section-content markdown-body" v-html="renderedStepsToReproduce"></div>
            </div>

            <div class="card-section" v-if="vulnerability.recommendation">
              <h4 class="section-title">修复建议</h4>
              <div class="section-content markdown-body" v-html="renderedRecommendation"></div>
            </div>
          </el-card>

          <!-- 右侧信息卡片 -->
          <div class="side-cards">
            <!-- 风险评分卡片 -->
            <el-card class="details-card risk-score-card">
              <template #header>
                <div class="card-header">
                  <h3>风险评分</h3>
                </div>
              </template>
              
              <div class="cvss-score">
                <div class="score-circle" :class="cvssScoreClass">
                  <span class="score-value">{{ vulnerability.cvss?.toFixed(1) || 'N/A' }}</span>
                </div>
                <div class="score-text">
                  <div class="score-level">{{ cvssScoreText }}</div>
                  <div class="score-label">CVSS 评分</div>
                </div>
              </div>
              
              <div class="cvss-vector" v-if="vulnerability.cvss_vector">
                <div class="vector-label">CVSS 向量:</div>
                <div class="vector-value">{{ vulnerability.cvss_vector }}</div>
              </div>
            </el-card>

            <!-- 受影响资产卡片 -->
            <el-card class="details-card assets-card" v-if="vulnerability.affected_assets && vulnerability.affected_assets.length">
              <template #header>
                <div class="card-header">
                  <h3>受影响资产</h3>
                </div>
              </template>
              
              <ul class="assets-list">
                <li v-for="(asset, index) in vulnerability.affected_assets" :key="index" class="asset-item">
                  <div class="asset-name">{{ asset.name || '未命名资产' }}</div>
                  <div class="asset-details" v-if="asset.details">{{ asset.details }}</div>
                </li>
              </ul>
            </el-card>
            
            <!-- 漏洞参考信息卡片 -->
            <el-card class="details-card references-card" v-if="vulnerability.references && vulnerability.references.length">
              <template #header>
                <div class="card-header">
                  <h3>参考信息</h3>
                </div>
              </template>
              
              <ul class="references-list">
                <li v-for="(reference, index) in vulnerability.references" :key="index" class="reference-item">
                  <a :href="reference.url" target="_blank" rel="noopener noreferrer">
                    {{ reference.title || reference.url }}
                  </a>
                </li>
              </ul>
            </el-card>
            
            <!-- 相关标签卡片 -->
            <el-card class="details-card tags-card" v-if="vulnerability.tags && vulnerability.tags.length">
              <template #header>
                <div class="card-header">
                  <h3>标签</h3>
                </div>
              </template>
              
              <div class="tags-container">
                <el-tag 
                  v-for="tag in vulnerability.tags" 
                  :key="tag" 
                  class="tag-item"
                  size="medium"
                >
                  {{ tag }}
                </el-tag>
              </div>
            </el-card>
          </div>
        </div>
        
        <!-- 漏洞历史记录 -->
        <el-card class="details-card history-card" v-if="vulnerability.history && vulnerability.history.length">
          <template #header>
            <div class="card-header">
              <h3>历史记录</h3>
            </div>
          </template>
          
          <el-timeline>
            <el-timeline-item
              v-for="(history, index) in vulnerability.history"
              :key="index"
              :timestamp="$filters.formatDateTime(history.timestamp)"
              :type="historyItemType(history.action)"
            >
              <div class="history-item">
                <span class="history-action">{{ historyActionText(history) }}</span>
                <span class="history-user" v-if="history.user">
                  由 <strong>{{ history.user.name || history.user.username }}</strong> 操作
                </span>
              </div>
              <div class="history-details" v-if="history.details">
                {{ history.details }}
              </div>
            </el-timeline-item>
          </el-timeline>
        </el-card>
      </template>
    </div>
  </div>
</template>

<script>
import { computed, onMounted, ref } from 'vue'
import { useStore } from 'vuex'
import { useRoute, useRouter } from 'vue-router'
import { ElMessageBox, ElMessage } from 'element-plus'

export default {
  name: 'VulnerabilityDetails',
  
  setup() {
    const store = useStore()
    const route = useRoute()
    const router = useRouter()
    
    const loading = ref(true)
    const vulnerability = computed(() => store.getters['vulnerability/currentVulnerability'] || {})
    const canEdit = computed(() => store.getters['auth/isAuthenticated'])
    
    // CVSS相关计算
    const cvssScoreClass = computed(() => {
      const score = vulnerability.value.cvss
      if (!score) return ''
      
      if (score >= 9.0) return 'critical'
      if (score >= 7.0) return 'high'
      if (score >= 4.0) return 'medium'
      return 'low'
    })
    
    const cvssScoreText = computed(() => {
      const score = vulnerability.value.cvss
      if (!score) return '未评分'
      
      if (score >= 9.0) return '严重'
      if (score >= 7.0) return '高危'
      if (score >= 4.0) return '中危'
      if (score > 0) return '低危'
      return '未评分'
    })
    
    // 简化的内容渲染，不使用marked和dompurify
    const renderedDescription = computed(() => {
      return vulnerability.value.description 
        ? `<p>${vulnerability.value.description}</p>`
        : '<p>暂无描述</p>'
    })
    
    const renderedImpact = computed(() => {
      return vulnerability.value.impact 
        ? `<p>${vulnerability.value.impact}</p>`
        : ''
    })
    
    const renderedStepsToReproduce = computed(() => {
      return vulnerability.value.steps_to_reproduce 
        ? `<p>${vulnerability.value.steps_to_reproduce}</p>`
        : ''
    })
    
    const renderedRecommendation = computed(() => {
      return vulnerability.value.recommendation 
        ? `<p>${vulnerability.value.recommendation}</p>`
        : ''
    })
    
    // 获取漏洞详情
    const fetchVulnerabilityDetails = async () => {
      loading.value = true
      try {
        await store.dispatch('vulnerability/fetchVulnerabilityById', route.params.id)
      } catch (error) {
        ElMessage.error('获取漏洞详情失败: ' + (error.message || '未知错误'))
      } finally {
        loading.value = false
      }
    }
    
    // 返回列表
    const goBack = () => {
      router.push('/vulnerabilities')
    }
    
    // 编辑漏洞
    const handleEdit = () => {
      router.push(`/vulnerabilities/${vulnerability.value.id}/edit`)
    }
    
    // 处理下拉菜单命令
    const handleCommand = (command) => {
      if (command === 'delete') {
        confirmDelete()
      } else {
        updateStatus(command)
      }
    }
    
    // 确认删除
    const confirmDelete = () => {
      ElMessageBox.confirm(
        `确定要删除漏洞 "${vulnerability.value.title}" 吗？`,
        '警告',
        {
          confirmButtonText: '确定',
          cancelButtonText: '取消',
          type: 'warning'
        }
      ).then(() => {
        deleteVulnerability()
      }).catch(() => {
        ElMessage({
          type: 'info',
          message: '已取消删除'
        })
      })
    }
    
    // 删除漏洞
    const deleteVulnerability = async () => {
      try {
        await store.dispatch('vulnerability/deleteVulnerability', vulnerability.value.id)
        
        // 刷新仪表盘数据
        store.dispatch('dashboard/fetchDashboardData')
        
        ElMessage({
          type: 'success',
          message: '漏洞已成功删除'
        })
        
        // 返回列表页
        router.push('/vulnerabilities')
      } catch (error) {
        ElMessage({
          type: 'error',
          message: '删除失败: ' + (error.message || '未知错误')
        })
      }
    }
    
    // 更新漏洞状态
    const updateStatus = async (status) => {
      try {
        await store.dispatch('vulnerability/updateVulnerability', {
          id: vulnerability.value.id,
          data: { status }
        })
        ElMessage({
          type: 'success',
          message: '漏洞状态已更新'
        })
        fetchVulnerabilityDetails()
      } catch (error) {
        ElMessage({
          type: 'error',
          message: '更新状态失败: ' + (error.message || '未知错误')
        })
      }
    }
    
    // 历史记录项类型
    const historyItemType = (action) => {
      switch (action) {
        case 'create':
          return 'success'
        case 'update':
          return 'warning'
        case 'delete':
          return 'danger'
        case 'status_change':
          return 'primary'
        default:
          return 'info'
      }
    }
    
    // 历史记录操作文本
    const historyActionText = (history) => {
      switch (history.action) {
        case 'create':
          return '创建漏洞'
        case 'update':
          return '更新漏洞信息'
        case 'delete':
          return '删除漏洞'
        case 'status_change':
          return `状态变更为 ${history.details || '未知状态'}`
        default:
          return history.action || '未知操作'
      }
    }
    
    onMounted(() => {
      fetchVulnerabilityDetails()
    })
    
    return {
      loading,
      vulnerability,
      canEdit,
      cvssScoreClass,
      cvssScoreText,
      renderedDescription,
      renderedImpact,
      renderedStepsToReproduce,
      renderedRecommendation,
      goBack,
      handleEdit,
      handleCommand,
      confirmDelete,
      historyItemType,
      historyActionText
    }
  }
}
</script>

<style lang="scss" scoped>
.vulnerability-details-page {
  margin-bottom: 40px;
}

.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
}

.header-actions {
  display: flex;
  gap: 12px;
}

.vuln-header {
  margin-bottom: 24px;
  display: flex;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 20px;
}

.vuln-title-section {
  flex: 1;
  min-width: 300px;
}

.vuln-title {
  font-size: 24px;
  font-weight: 600;
  margin: 0 0 12px 0;
  color: #2c3e50;
}

.vuln-meta {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 12px;
}

.vuln-id, .vuln-cve {
  color: #606266;
  font-size: 14px;
}

.vuln-dates {
  display: flex;
  gap: 24px;
}

.date-item {
  text-align: right;
}

.date-label {
  color: #909399;
  font-size: 13px;
  margin-bottom: 4px;
}

.date-value {
  font-size: 14px;
  font-weight: 500;
}

.details-grid {
  display: grid;
  grid-template-columns: 3fr 1fr;
  gap: 24px;
  margin-bottom: 24px;
}

.details-card {
  margin-bottom: 24px;
  box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.05);
}

.card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  
  h3 {
    margin: 0;
    font-weight: 600;
    font-size: 18px;
    color: #303133;
  }
}

.card-section {
  margin-bottom: 24px;
  
  &:last-child {
    margin-bottom: 0;
  }
}

.section-title {
  font-size: 16px;
  font-weight: 600;
  color: #303133;
  margin: 0 0 12px 0;
  padding-bottom: 8px;
  border-bottom: 1px solid #EBEEF5;
}

.section-content {
  color: #606266;
  line-height: 1.6;
}

.main-info-card {
  grid-column: 1;
}

.side-cards {
  grid-column: 2;
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.risk-score-card {
  margin-bottom: 0;
}

.cvss-score {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 16px;
}

.score-circle {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  font-weight: 700;
  color: #fff;
  
  &.critical {
    background-color: #F56C6C;
  }
  
  &.high {
    background-color: #E6A23C;
  }
  
  &.medium {
    background-color: #E6A23C;
  }
  
  &.low {
    background-color: #67C23A;
  }
}

.score-text {
  display: flex;
  flex-direction: column;
}

.score-level {
  font-size: 18px;
  font-weight: 600;
}

.score-label {
  font-size: 14px;
  color: #909399;
}

.cvss-vector {
  padding: 12px;
  background-color: #F5F7FA;
  border-radius: 4px;
  font-family: monospace;
  font-size: 14px;
  line-height: 1.5;
  word-break: break-all;
}

.assets-list, .references-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.asset-item, .reference-item {
  padding: 12px 0;
  border-bottom: 1px solid #EBEEF5;
  
  &:last-child {
    border-bottom: none;
  }
}

.asset-name {
  font-weight: 500;
  margin-bottom: 4px;
}

.asset-details {
  font-size: 14px;
  color: #606266;
}

.tags-container {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.history-card {
  grid-column: 1 / -1;
}

.history-item {
  margin-bottom: 8px;
}

.history-action {
  font-weight: 500;
}

.history-user {
  font-size: 14px;
  color: #606266;
  margin-left: 8px;
}

.history-details {
  font-size: 14px;
  color: #606266;
  background-color: #F5F7FA;
  padding: 8px 12px;
  border-radius: 4px;
  margin-top: 8px;
}

// 为Markdown内容添加样式
:deep(.markdown-body) {
  h1, h2, h3, h4, h5, h6 {
    margin-top: 24px;
    margin-bottom: 16px;
    font-weight: 600;
    line-height: 1.25;
  }
  
  h1 {
    font-size: 2em;
  }
  
  h2 {
    font-size: 1.5em;
  }
  
  h3 {
    font-size: 1.25em;
  }
  
  p, blockquote, ul, ol, dl, table, pre {
    margin-top: 0;
    margin-bottom: 16px;
  }
  
  ul, ol {
    padding-left: 2em;
  }
  
  li + li {
    margin-top: 0.25em;
  }
  
  code {
    font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
    padding: 0.2em 0.4em;
    margin: 0;
    font-size: 85%;
    background-color: rgba(27, 31, 35, 0.05);
    border-radius: 3px;
  }
  
  pre {
    font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
    word-wrap: normal;
    padding: 16px;
    overflow: auto;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f6f8fa;
    border-radius: 3px;
    
    code {
      background-color: transparent;
      padding: 0;
      margin: 0;
      font-size: 100%;
      word-break: normal;
      white-space: pre;
      border: 0;
    }
  }
}

@media (max-width: 1024px) {
  .details-grid {
    grid-template-columns: 1fr;
  }
  
  .main-info-card,
  .side-cards,
  .history-card {
    grid-column: 1;
  }
}

@media (max-width: 768px) {
  .vuln-header {
    flex-direction: column;
  }
  
  .vuln-dates {
    width: 100%;
    justify-content: flex-start;
  }
  
  .date-item {
    text-align: left;
  }
}
</style> 