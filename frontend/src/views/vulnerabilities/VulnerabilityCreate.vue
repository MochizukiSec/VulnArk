<template>
  <div class="vulnerability-create-page">
    <!-- 页面标题 -->
    <div class="page-header">
      <div class="header-content">
        <div class="header-back">
          <el-button @click="goBack" icon="el-icon-arrow-left" type="text" class="back-button">
            返回列表
          </el-button>
        </div>
        <h1 class="page-title">
          <span class="title-icon"><i class="el-icon-plus"></i></span>
          创建新漏洞
          <span class="title-highlight">记录</span>
        </h1>
        <p class="page-subtitle">添加新发现的安全漏洞，记录详细信息以便团队跟进处理</p>
      </div>
    </div>

    <div class="form-card">
      <el-form 
        ref="formRef"
        :model="vulnerabilityForm" 
        :rules="rules" 
        label-position="top"
        v-loading="loading"
      >
        <!-- 基本信息卡片 -->
        <div class="section-card">
          <div class="section-header">
            <h2 class="section-title">
              <i class="el-icon-info section-icon"></i>
              基本信息
            </h2>
            <span class="section-subtitle">漏洞的基本描述和分类信息</span>
          </div>

          <el-row :gutter="24">
            <el-col :xs="24" :sm="24" :md="24">
              <el-form-item label="漏洞标题" prop="title">
                <el-input 
                  v-model="vulnerabilityForm.title" 
                  placeholder="输入漏洞标题，简洁且能清晰表明漏洞类型"
                />
              </el-form-item>
            </el-col>
          </el-row>

          <el-row :gutter="24">
            <el-col :xs="24" :sm="12" :md="8">
              <el-form-item label="CVE编号" prop="cve">
                <el-input 
                  v-model="vulnerabilityForm.cve" 
                  placeholder="例如: CVE-2023-12345（如有）"
                  clearable
                />
              </el-form-item>
            </el-col>
            <el-col :xs="24" :sm="12" :md="8">
              <el-form-item label="严重程度" prop="severity">
                <el-select 
                  v-model="vulnerabilityForm.severity" 
                  placeholder="选择漏洞严重程度" 
                  style="width: 100%"
                >
                  <el-option label="严重" value="critical">
                    <template #default>
                      <div class="severity-option">
                        <span class="severity-dot critical"></span>
                        <span>严重</span>
                      </div>
                    </template>
                  </el-option>
                  <el-option label="高危" value="high">
                    <template #default>
                      <div class="severity-option">
                        <span class="severity-dot high"></span>
                        <span>高危</span>
                      </div>
                    </template>
                  </el-option>
                  <el-option label="中危" value="medium">
                    <template #default>
                      <div class="severity-option">
                        <span class="severity-dot medium"></span>
                        <span>中危</span>
                      </div>
                    </template>
                  </el-option>
                  <el-option label="低危" value="low">
                    <template #default>
                      <div class="severity-option">
                        <span class="severity-dot low"></span>
                        <span>低危</span>
                      </div>
                    </template>
                  </el-option>
                  <el-option label="信息" value="info">
                    <template #default>
                      <div class="severity-option">
                        <span class="severity-dot info"></span>
                        <span>信息</span>
                      </div>
                    </template>
                  </el-option>
                </el-select>
              </el-form-item>
            </el-col>
            <el-col :xs="24" :sm="12" :md="8">
              <el-form-item label="状态" prop="status">
                <el-select 
                  v-model="vulnerabilityForm.status" 
                  placeholder="选择漏洞状态" 
                  style="width: 100%"
                >
                  <el-option label="开放" value="open" />
                  <el-option label="处理中" value="in_progress" />
                  <el-option label="已解决" value="resolved" />
                  <el-option label="已关闭" value="closed" />
                  <el-option label="误报" value="false_positive" />
                </el-select>
              </el-form-item>
            </el-col>
          </el-row>

          <el-row :gutter="24">
            <el-col :xs="24" :sm="12" :md="8">
              <el-form-item label="发现日期" prop="discoveredAt">
                <el-date-picker 
                  v-model="vulnerabilityForm.discoveredAt" 
                  type="date" 
                  placeholder="选择漏洞发现日期"
                  value-format="yyyy-MM-dd"
                  style="width: 100%"
                />
              </el-form-item>
            </el-col>
            <el-col :xs="24" :sm="12" :md="8">
              <el-form-item label="CVSS评分" prop="cvss">
                <el-input-number 
                  v-model="vulnerabilityForm.cvss" 
                  :min="0" 
                  :max="10" 
                  :precision="1" 
                  :step="0.1"
                  style="width: 100%"
                />
              </el-form-item>
            </el-col>
            <el-col :xs="24" :sm="12" :md="8">
              <el-form-item label="CVSS向量" prop="cvss_vector">
                <el-input 
                  v-model="vulnerabilityForm.cvss_vector" 
                  placeholder="例如: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H"
                  clearable
                />
              </el-form-item>
            </el-col>
          </el-row>
        </div>

        <!-- 详细描述卡片 -->
        <div class="section-card">
          <div class="section-header">
            <h2 class="section-title">
              <i class="el-icon-document section-icon"></i>
              详细描述
            </h2>
            <span class="section-subtitle">漏洞的详细描述和分析</span>
          </div>

          <el-form-item label="漏洞描述" prop="description">
            <el-tabs v-model="descriptionTab">
              <el-tab-pane label="编辑" name="edit">
                <el-input 
                  v-model="vulnerabilityForm.description" 
                  type="textarea" 
                  :rows="8"
                  placeholder="详细描述漏洞的情况、原理等信息（支持Markdown格式）"
                />
              </el-tab-pane>
              <el-tab-pane label="预览" name="preview">
                <div v-if="!vulnerabilityForm.description" class="empty-preview">
                  暂无内容预览
                </div>
                <div v-else class="markdown-preview" v-html="renderedDescription"></div>
              </el-tab-pane>
            </el-tabs>
          </el-form-item>

          <el-form-item label="影响分析" prop="impact">
            <el-tabs v-model="impactTab">
              <el-tab-pane label="编辑" name="edit">
                <el-input 
                  v-model="vulnerabilityForm.impact" 
                  type="textarea" 
                  :rows="6"
                  placeholder="描述漏洞可能造成的安全影响和危害（支持Markdown格式）"
                />
              </el-tab-pane>
              <el-tab-pane label="预览" name="preview">
                <div v-if="!vulnerabilityForm.impact" class="empty-preview">
                  暂无内容预览
                </div>
                <div v-else class="markdown-preview" v-html="renderedImpact"></div>
              </el-tab-pane>
            </el-tabs>
          </el-form-item>

          <el-form-item label="复现步骤" prop="steps_to_reproduce">
            <el-tabs v-model="stepsTab">
              <el-tab-pane label="编辑" name="edit">
                <el-input 
                  v-model="vulnerabilityForm.steps_to_reproduce" 
                  type="textarea" 
                  :rows="6"
                  placeholder="详细列出漏洞的复现步骤，便于其他人理解和验证（支持Markdown格式）"
                />
              </el-tab-pane>
              <el-tab-pane label="预览" name="preview">
                <div v-if="!vulnerabilityForm.steps_to_reproduce" class="empty-preview">
                  暂无内容预览
                </div>
                <div v-else class="markdown-preview" v-html="renderedSteps"></div>
              </el-tab-pane>
            </el-tabs>
          </el-form-item>

          <el-form-item label="修复建议" prop="recommendation">
            <el-tabs v-model="recommendationTab">
              <el-tab-pane label="编辑" name="edit">
                <el-input 
                  v-model="vulnerabilityForm.recommendation" 
                  type="textarea" 
                  :rows="6"
                  placeholder="提供修复或缓解该漏洞的方法和建议（支持Markdown格式）"
                />
              </el-tab-pane>
              <el-tab-pane label="预览" name="preview">
                <div v-if="!vulnerabilityForm.recommendation" class="empty-preview">
                  暂无内容预览
                </div>
                <div v-else class="markdown-preview" v-html="renderedRecommendation"></div>
              </el-tab-pane>
            </el-tabs>
          </el-form-item>
        </div>

        <!-- 额外信息卡片 -->
        <div class="section-card">
          <div class="section-header">
            <h2 class="section-title">
              <i class="el-icon-info section-icon"></i>
              额外信息
            </h2>
            <span class="section-subtitle">受影响资产和参考链接</span>
          </div>

          <el-form-item label="受影响资产" prop="affected_assets">
            <el-tag
              v-for="(asset, index) in vulnerabilityForm.affected_assets"
              :key="index"
              closable
              :disable-transitions="false"
              @close="handleRemoveAsset(asset)"
              class="tag-item"
            >
              {{ asset.name }}
            </el-tag>
            <el-button type="text" @click="showAssetDialog" class="add-tag-button">
              <i class="el-icon-plus"></i> 添加资产
            </el-button>
          </el-form-item>

          <el-form-item label="参考链接" prop="references">
            <div v-for="(reference, index) in vulnerabilityForm.references" :key="index" class="reference-item">
              <el-input 
                v-model="reference.title" 
                placeholder="参考标题" 
                class="reference-title-input"
              />
              <el-input 
                v-model="reference.url" 
                placeholder="参考链接URL" 
                class="reference-url-input"
              />
              <el-button 
                type="danger" 
                icon="el-icon-delete" 
                circle 
                size="mini"
                @click="removeReference(index)"
              />
            </div>
            <el-button type="text" @click="addReference" class="add-reference-button">
              <i class="el-icon-plus"></i> 添加参考链接
            </el-button>
          </el-form-item>
        </div>

        <el-form-item label="标签" prop="tags">
          <el-tag
            v-for="tag in vulnerabilityForm.tags"
            :key="tag"
            closable
            :disable-transitions="false"
            @close="handleRemoveTag(tag)"
            class="tag-item"
          >
            {{ tag }}
          </el-tag>
          <el-input
            v-if="inputTagVisible"
            ref="tagInputRef"
            v-model="inputTagValue"
            class="tag-input"
            size="small"
            @keyup.enter="handleInputTagConfirm"
            @blur="handleInputTagConfirm"
          />
          <el-button v-else type="text" @click="showTagInput" class="add-tag-button">
            <i class="el-icon-plus"></i> 添加标签
          </el-button>
        </el-form-item>

        <!-- 表单底部操作按钮 -->
        <div class="form-actions">
          <el-button @click="goBack" class="cancel-btn">取消</el-button>
          <el-button type="primary" @click="submitForm" :loading="submitting" class="submit-btn">
            <i class="el-icon-check"></i> 保存漏洞
          </el-button>
        </div>
      </el-form>
    </div>

    <!-- 添加资产对话框 -->
    <el-dialog
      title="添加受影响资产"
      v-model="assetDialogVisible"
      width="500px"
    >
      <el-form :model="assetForm" label-position="top">
        <el-form-item label="资产名称" required>
          <el-input v-model="assetForm.name" placeholder="输入资产名称" />
        </el-form-item>
        <el-form-item label="资产详情">
          <el-input 
            v-model="assetForm.details" 
            type="textarea" 
            :rows="3"
            placeholder="对资产的详细描述，如版本、位置等"
          />
        </el-form-item>
      </el-form>
      <template #footer>
        <span class="dialog-footer">
          <el-button @click="assetDialogVisible = false">取消</el-button>
          <el-button type="primary" @click="handleAddAsset">添加</el-button>
        </span>
      </template>
    </el-dialog>
  </div>
</template>

<script>
import { ref, reactive, computed, nextTick } from 'vue'
import { useStore } from 'vuex'
import { useRouter } from 'vue-router'
import { ElMessage, ElMessageBox } from 'element-plus'

export default {
  name: 'VulnerabilityCreate',
  
  setup() {
    const store = useStore()
    const router = useRouter()
    const formRef = ref(null)
    
    const loading = ref(false)
    const submitting = ref(false)
    
    // Markdown 编辑的标签页状态
    const descriptionTab = ref('edit')
    const impactTab = ref('edit')
    const stepsTab = ref('edit')
    const recommendationTab = ref('edit')
    
    // 标签输入相关
    const tagInputRef = ref(null)
    const inputTagVisible = ref(false)
    const inputTagValue = ref('')
    
    // 资产对话框
    const assetDialogVisible = ref(false)
    const assetForm = reactive({
      name: '',
      details: ''
    })
    
    // 漏洞表单数据
    const vulnerabilityForm = reactive({
      title: '',
      description: '',
      impact: '',
      steps_to_reproduce: '',
      recommendation: '',
      severity: 'medium',
      status: 'open',
      cve: '',
      cvss: 0,
      cvss_vector: '',
      discoveredAt: new Date().toISOString().slice(0, 10),
      affected_assets: [],
      references: [],
      tags: []
    })
    
    // 表单验证规则
    const rules = {
      title: [
        { required: true, message: '请输入漏洞标题', trigger: 'blur' },
        { min: 3, max: 200, message: '长度在 3 到 200 个字符', trigger: 'blur' }
      ],
      description: [
        { required: true, message: '请输入漏洞描述', trigger: 'blur' }
      ],
      severity: [
        { required: true, message: '请选择严重程度', trigger: 'change' }
      ],
      status: [
        { required: true, message: '请选择漏洞状态', trigger: 'change' }
      ],
      discoveredAt: [
        { required: true, message: '请选择发现日期', trigger: 'change' }
      ]
    }
    
    // 简化的内容渲染，不使用marked和dompurify
    const renderedDescription = computed(() => {
      if (!vulnerabilityForm.description) return ''
      return `<p>${vulnerabilityForm.description}</p>`
    })
    
    const renderedImpact = computed(() => {
      if (!vulnerabilityForm.impact) return ''
      return `<p>${vulnerabilityForm.impact}</p>`
    })
    
    const renderedSteps = computed(() => {
      if (!vulnerabilityForm.steps_to_reproduce) return ''
      return `<p>${vulnerabilityForm.steps_to_reproduce}</p>`
    })
    
    const renderedRecommendation = computed(() => {
      if (!vulnerabilityForm.recommendation) return ''
      return `<p>${vulnerabilityForm.recommendation}</p>`
    })
    
    // 返回列表
    const goBack = () => {
      if (formHasChanges()) {
        ElMessageBox.confirm(
          '表单内容已修改，确定要离开吗？',
          '提示',
          {
            confirmButtonText: '确定',
            cancelButtonText: '取消',
            type: 'warning'
          }
        ).then(() => {
          router.push('/vulnerabilities')
        }).catch(() => {
          // 用户取消
        })
      } else {
        router.push('/vulnerabilities')
      }
    }
    
    // 判断表单是否有修改
    const formHasChanges = () => {
      return vulnerabilityForm.title ||
        vulnerabilityForm.description ||
        vulnerabilityForm.impact ||
        vulnerabilityForm.steps_to_reproduce ||
        vulnerabilityForm.recommendation ||
        vulnerabilityForm.cvss !== 0 ||
        vulnerabilityForm.cve ||
        vulnerabilityForm.cvss_vector ||
        vulnerabilityForm.affected_assets.length > 0 ||
        vulnerabilityForm.references.length > 0 ||
        vulnerabilityForm.tags.length > 0
    }
    
    // 提交表单
    const submitForm = async () => {
      if (!formRef.value) return
      
      try {
        await formRef.value.validate()
        
        submitting.value = true
        
        // 准备提交的数据
        const vulnerabilityData = { ...vulnerabilityForm }
        
        try {
          // 创建漏洞
          await store.dispatch('vulnerability/createVulnerability', vulnerabilityData)
          
          // 刷新仪表盘数据
          store.dispatch('dashboard/fetchDashboardData')
          
          ElMessage({
            type: 'success',
            message: '漏洞创建成功'
          })
          
          router.push('/vulnerabilities')
        } catch (error) {
          ElMessage({
            type: 'error',
            message: '创建漏洞失败: ' + (error.message || '未知错误')
          })
        } finally {
          submitting.value = false
        }
      } catch (error) {
        ElMessage({
          type: 'warning',
          message: '请完善表单信息'
        })
      }
    }
    
    // 标签相关方法
    const showTagInput = () => {
      inputTagVisible.value = true
      nextTick(() => {
        tagInputRef.value?.focus()
      })
    }
    
    const handleInputTagConfirm = () => {
      const inputValue = inputTagValue.value.trim()
      if (inputValue && !vulnerabilityForm.tags.includes(inputValue)) {
        vulnerabilityForm.tags.push(inputValue)
      }
      inputTagVisible.value = false
      inputTagValue.value = ''
    }
    
    const handleRemoveTag = (tag) => {
      vulnerabilityForm.tags.splice(vulnerabilityForm.tags.indexOf(tag), 1)
    }
    
    // 资产相关方法
    const showAssetDialog = () => {
      assetForm.name = ''
      assetForm.details = ''
      assetDialogVisible.value = true
    }
    
    const handleAddAsset = () => {
      if (!assetForm.name.trim()) {
        ElMessage({
          type: 'warning',
          message: '请输入资产名称'
        })
        return
      }
      
      vulnerabilityForm.affected_assets.push({
        name: assetForm.name.trim(),
        details: assetForm.details.trim()
      })
      
      assetDialogVisible.value = false
    }
    
    const handleRemoveAsset = (asset) => {
      const index = vulnerabilityForm.affected_assets.findIndex(a => a.name === asset.name)
      if (index !== -1) {
        vulnerabilityForm.affected_assets.splice(index, 1)
      }
    }
    
    // 参考链接相关方法
    const addReference = () => {
      vulnerabilityForm.references.push({ title: '', url: '' })
    }
    
    const removeReference = (index) => {
      vulnerabilityForm.references.splice(index, 1)
    }
    
    return {
      formRef,
      loading,
      submitting,
      vulnerabilityForm,
      rules,
      descriptionTab,
      impactTab,
      stepsTab,
      recommendationTab,
      inputTagVisible,
      inputTagValue,
      tagInputRef,
      assetDialogVisible,
      assetForm,
      renderedDescription,
      renderedImpact,
      renderedSteps,
      renderedRecommendation,
      goBack,
      submitForm,
      showTagInput,
      handleInputTagConfirm,
      handleRemoveTag,
      showAssetDialog,
      handleAddAsset,
      handleRemoveAsset,
      addReference,
      removeReference
    }
  }
}
</script>

<style lang="scss" scoped>
.vulnerability-create-page {
  padding: 24px;
  animation: fadeIn 0.6s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.page-header {
  margin-bottom: 24px;
  
  .header-back {
    margin-bottom: 16px;
    
    .back-button {
      display: flex;
      align-items: center;
      color: #409EFF;
      padding: 0;
      transition: all 0.3s;
      
      i {
        margin-right: 6px;
        font-size: 16px;
      }
      
      &:hover {
        transform: translateX(-4px);
        color: #66b1ff;
      }
    }
  }
  
  .page-title {
    font-size: 28px;
    font-weight: 600;
    margin: 0 0 8px 0;
    display: flex;
    align-items: center;
    color: #303133;
    
    .title-icon {
      margin-right: 12px;
      font-size: 28px;
      color: #409EFF;
    }
    
    .title-highlight {
      background: linear-gradient(120deg, #409EFF, #53A8FF);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-left: 8px;
      font-weight: 700;
    }
  }
  
  .page-subtitle {
    color: #606266;
    font-size: 16px;
    margin: 0;
  }
}

.form-card {
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
  padding: 20px;
  margin-bottom: 24px;
  transition: all 0.3s ease;
  
  &:hover {
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
  }
}

.section-card {
  background: #f9fbfd;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 24px;
  transition: all 0.3s ease;
  
  &:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
  }
}

.section-header {
  display: flex;
  flex-direction: column;
  margin-bottom: 20px;
  
  .section-title {
    font-size: 18px;
    font-weight: 600;
    margin: 0 0 6px 0;
    color: #303133;
    display: flex;
    align-items: center;
    
    .section-icon {
      margin-right: 8px;
      color: #409EFF;
    }
  }
  
  .section-subtitle {
    color: #909399;
    font-size: 14px;
  }
}

.form-actions {
  display: flex;
  justify-content: flex-end;
  margin-top: 32px;
  gap: 12px;
  
  .cancel-btn {
    border-radius: 8px;
    padding: 10px 20px;
  }
  
  .submit-btn {
    border-radius: 8px;
    padding: 10px 24px;
    font-weight: 500;
    transition: all 0.3s;
    
    i {
      margin-right: 6px;
    }
    
    &:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(64, 158, 255, 0.2);
    }
  }
}

.severity-option {
  display: flex;
  align-items: center;
  
  .severity-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 8px;
    
    &.critical {
      background-color: #F44336;
    }
    
    &.high {
      background-color: #FF9800;
    }
    
    &.medium {
      background-color: #FFEB3B;
    }
    
    &.low {
      background-color: #4CAF50;
    }
    
    &.info {
      background-color: #2196F3;
    }
  }
}

// 表单元素样式优化
:deep(.el-form-item__label) {
  padding-bottom: 8px;
  font-weight: 500;
  color: #606266;
}

:deep(.el-input__inner), :deep(.el-textarea__inner) {
  border-radius: 8px;
  transition: all 0.3s;
  
  &:focus {
    box-shadow: 0 0 0 2px rgba(64, 158, 255, 0.2);
  }
}

:deep(.el-select-dropdown__item) {
  padding: 8px 12px;
}

// 响应式调整
@media (max-width: 768px) {
  .vulnerability-create-page {
    padding: 16px;
  }
  
  .page-header {
    .page-title {
      font-size: 24px;
      
      .title-icon {
        font-size: 24px;
      }
    }
    
    .page-subtitle {
      font-size: 14px;
    }
  }
  
  .form-card, .section-card {
    padding: 16px;
  }
  
  .section-header {
    .section-title {
      font-size: 16px;
    }
  }
  
  .form-actions {
    flex-direction: column-reverse;
    
    .el-button {
      width: 100%;
    }
  }
}
</style> 